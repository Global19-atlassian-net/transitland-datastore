machine:
  ruby:
    version: 2.2.3

test:
  post:
    - mkdir $CIRCLE_ARTIFACTS/profiling
  override:
    - RAILS_ENV=test bundle exec rspec -r rspec_junit_formatter --format RspecJunitFormatter -o $CIRCLE_TEST_REPORTS/rspec/junit.xml
    - RAILS_ENV=test bundle exec rake profile:test[$CIRCLE_ARTIFACTS/profiling]

deployment:
  staging:
    branch: master
    commands:
      - ./deploy/env.rb staging
  production:
    branch: production
    commands:
      - ./deploy/env.rb prod
